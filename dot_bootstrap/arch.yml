---
- name: Arch Linux setup
  hosts: localhost
  connection: local
  remote_user: czyrar
  become: false
  vars:
    user: czyrar

  tasks:
    - name: Full system upgrade
      become: true
      remote_user: root
      community.general.pacman:
        update_cache: true
        upgrade: true

    - name: Install packages
      become: true
      remote_user: root
      community.general.pacman:
        name:
          # Basic stuff
          - base-devel
          - grep
          - wget
          - vi
          - vim
          - sed
          - curl
          - rsync
          - bat
          - eza
          - openssl
          - zlib
          - pipewire
          - pipewire-alsa
          - pipewire-jack
          - pipewire-pulse
          - wireplumber
          - ly
          - uwsm
          - app2unit
          - snap-pac
          - brightnessctl
          - dash
          - iwd
          - wireguard-tools
          - snapper
          - man-db
          - man-pages
          # Graphical apps
          - vlc
          - kitty
          - nemo
          - evince
          - gimp
          - inkscape
          - imagemagick
          - keepassxc
          - libreoffice-fresh
          - obsidian
          - spotify-launcher
          - discord
          - xournalpp
          - qbittorrent
          - krita
          - mpv
          - eog
          ## Hyprland
          - hyprland
          - xdg-desktop-portal-hyprland
          - xdg-desktop-portal-gtk
          - hypridle
          - hyprlock
          - hyprpicker
          - hyprshot
          - hyprpolkitagent
          - hyprland-qt-support
          - qt5-wayland
          - qt6-wayland
          - dunst
          ## Waybar
          - waybar
          - bluetui
          - btop
          - impala
          - papirus-icon-theme
          - power-profiles-daemon
          - rclone
          - wlogout
          ## Extra
          - fuzzel
          - swww
          - hyfetch
          - fastfetch
          - gpu-screen-recorder
          - pandoc-cli
          - speedtest-cli
          # Neovim
          - neovim
          - npm
          - tree-sitter-cli
          - ripgrep
          - fd
          - fzf
          - luarocks
          - ruby
          # Compilers
          - gcc
          - gcc-fortran
          - rustup
          - blas-openblas
          - make
          - docker
          - docker-compose
          ## Latex
          - texlive-basic
          - texlive-basic
          - texlive-bibtexextra
          - texlive-binextra
          - texlive-context
          - texlive-fontsextra
          - texlive-fontsrecommended
          - texlive-fontutils
          - texlive-formatsextra
          - texlive-games
          - texlive-humanities
          - texlive-latex
          - texlive-latexextra
          - texlive-latexrecommended
          - texlive-luatex
          - texlive-mathscience
          - texlive-metapost
          - texlive-music
          - texlive-pictures
          - texlive-plaingeneric
          - texlive-pstricks
          - texlive-publishers
          - texlive-xetex
          # ZSH
          - zsh
          - zoxide
        state: present

    - name: Check if yay is installed
      ansible.builtin.shell: "which yay"
      register: yay_installed
      ignore_errors: true
      changed_when: false

    - name: Download yay
      when: yay_installed is failed
      ansible.builtin.git:
        repo: "https://aur.archlinux.org/yay.git"
        dest: "~{{ user }}/yay"

    - name: Install yay
      when: yay_installed is failed
      ansible.builtin.shell: "makepkg -si"
      args:
        chdir: "~{{ user }}/yay"

    - name: Install AUR packages
      kewlfft.aur.aur:
        use: yay
        name:
          - xwaylandvideobridge
          - ani-cli
          - mangal-bin
          - juliaup
          - limine-snapper-sync
          - limine-mkinitcpio-hook
          - libadwaita-without-adwaita
          - soulseekqt
          - librewolf-bin
        state: present

    - name: Change shell to zsh
      ansible.builtin.user:
        name: "{{ user }}"
        shell: /usr/bin/zsh

    - name: Ensure fonts directory
      ansible.builtin.file:
        path: "~{{ user }}/.local/share/fonts"
        state: directory
        mode: "0755"
        owner: "{{ user }}"

    - name: Check if Maple Mono exists
      ansible.builtin.shell: "ls ~{{ user }}/.local/share/fonts/MapleMono-NF-CN"
      register: maple_mono_exists
      ignore_errors: true
      changed_when: false

    - name: Download Maple Mono
      when: maple_mono_exists is failed
      ansible.builtin.git:
        repo: "https://github.com/czyrar/maple_mono.git"
        dest: "~{{ user }}/.local/share/fonts/MapleMono-NF-CN"

    - name: Check if there is neovim config
      ansible.builtin.shell: "ls ~{{ user }}/.config/nvim"
      register: nvim_exists
      ignore_errors: true
      changed_when: false

    - name: Install neovim configuration
      when: nvim_exists is failed
      ansible.builtin.git:
        repo: "https://github.com/czyrar/nvim.git"
        dest: "~{{ user }}/.config/nvim"
